<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barter.org.il | זירת הברטר של העצמאים</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' }
                    },
                    fontFamily: { sans: ['Assistant', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 flex flex-col min-h-screen">
    
    <div id="root"></div>

    <script type="text/babel">
        
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8b2B9twtEvjNW9W6yF8MriqAICyd0F64",
            authDomain: "barter-app-final.firebaseapp.com",
            projectId: "barter-app-final",
            storageBucket: "barter-app-final.firebasestorage.app",
            messagingSenderId: "376228645270",
            appId: "1:376228645270:web:d048f54c13a280051db5b7"
        };

        const GEMINI_API_KEY = "AIzaSyDQpdTeRrPk-6iYgz8zOlgdW7UitohoWzA";
        
        // ==========================================
        // 2. GLOBAL CONSTANTS (DEFINED ONCE)
        // ==========================================
        
        const ADMIN_EMAIL = "yaikov.p.0548562029@gmail.com";
        
        const CATEGORIES = ["פיתוח אתרים", "עיצוב גרפי", "שיווק דיגיטלי", "ייעוץ עסקי", "צילום ועריכה", "משפטים", "חשבונאות"];
        const COMMON_INTERESTS = ["ספורט", "מוזיקה", "טיולים", "קולנוע", "בישול", "טכנולוגיה", "אופנה", "עיצוב", "גיימינג", "נדל״ן"];
        
        // ==========================================
        // 3. INITIALIZATION
        // ==========================================

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // 4. INLINE ICONS
        // ==========================================
        const IconBase = ({ d, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{d}</svg>
        );

        const Icons = {
            ArrowRightLeft: (p) => <IconBase {...p} d={<><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></>} />,
            Menu: (p) => <IconBase {...p} d={<><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>} />,
            X: (p) => <IconBase {...p} d={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            PlusCircle: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>} />,
            MessageSquare: (p) => <IconBase {...p} d={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>} />,
            LogOut: (p) => <IconBase {...p} d={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Shield: (p) => <IconBase {...p} d={<><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></>} />,
            FileText: (p) => <IconBase {...p} d={<><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></>} />,
            Search: (p) => <IconBase {...p} d={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4-4"/></>} />,
            Megaphone: (p) => <IconBase {...p} d={<><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></>} />,
            BarChart3: (p) => <IconBase {...p} d={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} />,
            Wallet: (p) => <IconBase {...p} d={<><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></>} />,
            Users: (p) => <IconBase {...p} d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            TrendingUp: (p) => <IconBase {...p} d={<><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></>} />,
            ExternalLink: (p) => <IconBase {...p} d={<><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></>} />,
            ChevronLeft: (p) => <IconBase {...p} d={<><path d="m15 18-6-6 6-6"/></>} />,
            ChevronRight: (p) => <IconBase {...p} d={<><path d="m9 18 6-6-6-6"/></>} />,
            MapPin: (p) => <IconBase {...p} d={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
            Calendar: (p) => <IconBase {...p} d={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
            ChevronDown: (p) => <IconBase {...p} d={<><path d="m6 9 6 6 6-6"/></>} />,
            ChevronUp: (p) => <IconBase {...p} d={<><path d="m18 15-6-6-6 6"/></>} />,
            Star: (p) => <IconBase {...p} d={<><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></>} />,
            Trash2: (p) => <IconBase {...p} d={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Clock: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Repeat: (p) => <IconBase {...p} d={<><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></>} />,
            EyeOff: (p) => <IconBase {...p} d={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />,
            Sparkles: (p) => <IconBase {...p} d={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/></>} />,
            Loader2: (p) => <IconBase {...p} d={<><path d="M21 12a9 9 0 1 1-6.219-8.56"/></>} />,
            Tag: (p) => <IconBase {...p} d={<><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828l-5-5Z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></>} />,
            CheckCircle: (p) => <IconBase {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            Mail: (p) => <IconBase {...p} d={<><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>} />,
            Lock: (p) => <IconBase {...p} d={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            Briefcase: (p) => <IconBase {...p} d={<><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />,
            Heart: (p) => <IconBase {...p} d={<><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></>} />,
            Plus: (p) => <IconBase {...p} d={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Camera: (p) => <IconBase {...p} d={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Upload: (p) => <IconBase {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Save: (p) => <IconBase {...p} d={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Filter: (p) => <IconBase {...p} d={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            ArrowUpDown: (p) => <IconBase {...p} d={<><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></>} />,
            LayoutGrid: (p) => <IconBase {...p} d={<><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></>} />,
            ListIcon: (p) => <IconBase {...p} d={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />,
            Send: (p) => <IconBase {...p} d={<><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            CheckCircle2: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            MessageCircle: (p) => <IconBase {...p} d={<><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></>} />,
            Pencil: (p) => <IconBase {...p} d={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></>} />,
            ArrowLeft: (p) => <IconBase {...p} d={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />,
            AlertTriangle: (p) => <IconBase {...p} d={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />,
            Facebook: (p) => <IconBase {...p} d={<><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></>} />,
            Instagram: (p) => <IconBase {...p} d={<><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></>} />,
            Linkedin: (p) => <IconBase {...p} d={<><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></>} />,
            Accessibility: (p) => <IconBase {...p} d={<><circle cx="16" cy="4" r="1"/><path d="m18 19 1-7-6 1"/><path d="m5 8 3-3 5.5 3-2.36 4.5"/><path d="M8 19l-1-7L6 9"/></>} />,
            Target: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />,
            Check: (p) => <IconBase {...p} d={<><polyline points="20 6 9 17 4 12"/></>} />,
            Handshake: (p) => <IconBase {...p} d={<><path d="m11 17 2 2a1 1 0 1 0 3-3"/><path d="m11 17 2 2"/><path d="m15.5 5.5-5 5"/><path d="M16.5 4.5a2.121 2.121 0 0 1 3 3L11 16l-3-3L16.5 4.5z"/><path d="m17 11 2 2"/><path d="m11 6-5 5a2.121 2.121 0 0 0 0 3l9 9a2.121 2.121 0 0 0 3 0l5-5a2.121 2.121 0 0 0 0-3L17 11l-2-2z"/></>} />,
            Bell: (p) => <IconBase {...p} d={<><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>} />,
            AlertCircle: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            RefreshCw: (p) => <IconBase {...p} d={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
            XCircle: (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />,
            Edit: (p) => <IconBase {...p} d={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            ShieldAlert: (p) => <IconBase {...p} d={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></>} />,
            User: (p) => <IconBase {...p} d={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            ImageIcon: (p) => <IconBase {...p} d={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />,
            Copy: (p) => <IconBase {...p} d={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            Link: (p) => <IconBase {...p} d={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />
        };

        // ==========================================
        // 5. SERVICES
        // ==========================================

        const optimizeOfferDescription = async (rawInput) => {
            if (!GEMINI_API_KEY) return null;
            try {
                const today = new Date().toISOString().split('T')[0];
                const prompt = `
                  Current Date: ${today}
                  Analyze this barter offer request: "${rawInput}"
                  Return a JSON object with:
                  - title (Hebrew, professional)
                  - description (Hebrew, persuasive)
                  - offeredService (Short Hebrew)
                  - requestedService (Short Hebrew)
                  - location (Hebrew, City or 'Remote')
                  - tags (Array of strings)
                  - expirationDate (YYYY-MM-DD, only if a deadline is explicitly mentioned relative to today)
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : null;
            } catch (error) {
                console.error("AI Error:", error);
                return null;
            }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                };
                reader.onerror = error => reject(error);
            });
        };

        // ==========================================
        // 6. COMPONENTS
        // ==========================================

        const ModalWrapper = ({ isOpen, onClose, children, title }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 overflow-y-auto">
                    <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
                        <div className="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" onClick={onClose}></div>
                        <div className="inline-block bg-white rounded-2xl text-right overflow-hidden shadow-xl transform transition-all sm:max-w-lg w-full">
                            <div className="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50">
                                <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                                <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icons.X className="w-5 h-5" /></button>
                            </div>
                            <div className="p-6 max-h-[80vh] overflow-y-auto custom-scrollbar">{children}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const Navbar = ({ currentUser, onOpenCreateModal, onOpenAuth, onLogout, onSearch, unreadCount, onOpenAdmin }) => {
            return (
                <nav className="bg-white border-b border-slate-200 sticky top-0 z-40">
                  <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between h-16">
                      <div className="flex items-center flex-1">
                        <div className="flex-shrink-0 flex items-center gap-2 cursor-pointer" onClick={() => window.scrollTo(0,0)}>
                          <div className="bg-brand-600 p-1.5 rounded-lg"><Icons.ArrowRightLeft className="h-6 w-6 text-white" /></div>
                          <span className="font-bold text-xl text-slate-800 hidden md:block">Barter.org.il</span>
                        </div>
                        <div className="hidden md:flex items-center mr-8 flex-1 max-w-lg">
                           <div className="relative w-full">
                              <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><Icons.Search className="h-4 w-4 text-slate-400" /></div>
                              <input type="text" className="block w-full pl-4 pr-10 py-1.5 border border-slate-300 rounded-full bg-slate-50 text-slate-900 text-sm focus:outline-none focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500" placeholder="חיפוש שירות..." onChange={(e) => onSearch(e.target.value)} />
                           </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 sm:gap-4">
                        {currentUser ? (
                          <>
                            {currentUser.email === ADMIN_EMAIL && (
                                <button onClick={onOpenAdmin} className="hidden sm:flex items-center gap-1 text-slate-600 hover:text-red-600 bg-red-50 px-2 py-1 rounded-lg text-xs font-bold">
                                    <Icons.ShieldAlert className="w-4 h-4" /> ניהול
                                </button>
                            )}
                            <div className="flex items-center gap-3 pl-2 border-r border-slate-200 mr-2">
                                <img src={currentUser.avatarUrl} className="w-8 h-8 rounded-full border border-slate-200 object-cover" />
                                <span className="text-sm font-medium text-slate-700 hidden lg:block">{currentUser.name}</span>
                                <button onClick={onLogout} className="text-slate-400 hover:text-red-500 p-1"><Icons.LogOut className="w-5 h-5" /></button>
                            </div>
                          </>
                        ) : (
                          <button onClick={onOpenAuth} className="text-sm font-medium text-slate-600 hover:text-brand-600">התחברות / הרשמה</button>
                        )}
                        <button onClick={onOpenCreateModal} className="bg-brand-600 hover:bg-brand-700 text-white px-3 sm:px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 shadow-sm transition-colors"><Icons.PlusCircle className="w-4 h-4" /><span className="inline">פרסם הצעה</span></button>
                      </div>
                    </div>
                  </div>
                </nav>
            );
        };

        const Hero = ({ onOpenAuth }) => {
            return (
                <div className="relative bg-white overflow-hidden flex flex-col lg:flex-row border-b border-slate-100 min-h-[600px]">
                  <div className="w-full lg:w-[55%] bg-white z-20 flex flex-col justify-center relative order-1 lg:order-1">
                      <main className="w-full max-w-2xl px-4 py-10 sm:px-6 lg:px-8 lg:py-24 flex flex-col items-end text-right mr-auto"> 
                        <div className="w-full pl-0 lg:pl-10">
                          <h1 className="text-4xl tracking-tight font-extrabold text-slate-900 sm:text-5xl md:text-6xl leading-tight">
                            <span className="block">הכלכלה החדשה של</span>
                            <span className="block text-brand-600 mt-1">העצמאים בישראל</span>
                          </h1>
                          <p className="mt-6 text-base text-slate-500 sm:mt-8 sm:text-lg sm:max-w-xl md:mt-8 md:text-xl leading-relaxed">
                            השתמשו בכישורים שלכם כדי לשלם על שירותים עסקיים. בלי להוציא מזומן, בלי עמלות נסתרות. נטוורקינג עסקי אמיתי שמייצר ערך מהיום הראשון.
                          </p>
                          <div className="mt-8 sm:mt-10 flex flex-col sm:flex-row gap-1.5 sm:gap-4 justify-start">
                            <button onClick={() => document.getElementById('feed').scrollIntoView({ behavior: 'smooth' })} className="w-full flex items-center justify-center px-8 py-4 border border-transparent text-base font-bold rounded-lg text-white bg-brand-600 hover:bg-brand-700 md:text-lg transition-all">מצאו שותף לברטר</button>
                            <button onClick={onOpenAuth} className="w-full flex items-center justify-center px-8 py-4 border border-slate-200 text-base font-bold rounded-lg text-brand-700 bg-brand-50 hover:bg-brand-100 md:text-lg transition-all">הרשמו והצטרפו לקהילה</button>
                          </div>
                        </div>
                      </main>
                  </div>
                  <div className="w-full lg:w-[45%] bg-slate-50 relative min-h-[500px] lg:min-h-full flex items-center justify-center overflow-hidden order-2 lg:order-2 border-t lg:border-t-0 lg:border-r border-slate-100 p-8">
                    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:20px_20px]"></div>
                    <div className="relative w-full max-w-sm flex flex-col gap-5">
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center flex-shrink-0"><Icons.Wallet className="w-6 h-6 text-emerald-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">חוסכים בהוצאות העסק</h3><p className="text-slate-500 text-sm leading-relaxed">משתמשים בכישרון שלכם כמטבע עבור הסוחר.<br/>מקבלים שירותים שווים בלי להוציא שקל.</p></div>
                        </div>
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center flex-shrink-0"><Icons.Users className="w-6 h-6 text-indigo-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">קהילה עסקית איכותית</h3><p className="text-slate-500 text-sm leading-relaxed">נבחרת של פרילנסרים ובעלי עסקים מנוסים. כאן תמצאו שותפים רציניים לעבודה.</p></div>
                        </div>
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-rose-50 rounded-xl flex items-center justify-center flex-shrink-0"><Icons.TrendingUp className="w-6 h-6 text-rose-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">הזדמנויות צמיחה</h3><p className="text-slate-500 text-sm leading-relaxed">הדרך הנכונה להגדיל את היקף העבודות, לייצר קשרים אסטרטגיים ולפרוץ לשווקים חדשים.</p></div>
                        </div>
                    </div>
                  </div>
                </div>
            );
        };

        const AdBanner = ({ ads, currentUser }) => {
            if (!ads || ads.length === 0) return null;
            
            // Filtering logic: Global OR Matches user field
            const relevantAds = ads.filter(ad => {
                if(!ad.isActive) return false;
                if(ad.targetCategories.includes('Global')) return true;
                if(currentUser && ad.targetCategories.includes(currentUser.mainField)) return true;
                return false;
            });

            if (relevantAds.length === 0) return null;

            return (
                <div className="w-full my-6 relative group overflow-hidden">
                  <div className="flex overflow-x-auto gap-4 pb-2 px-1 snap-x snap-mandatory scrollbar-hide">
                      {relevantAds.map((ad) => (
                        <div key={ad.id} className="flex-shrink-0 w-full sm:w-[480px] snap-center bg-white rounded-lg shadow-sm border border-slate-100 overflow-hidden flex flex-row h-32 hover:shadow-md transition-shadow duration-300 relative">
                                <div className="w-32 sm:w-40 h-full relative overflow-hidden flex-shrink-0">
                                    <img src={ad.imageUrl} className="w-full h-full object-cover" />
                                </div>
                                <div className="flex-1 p-3 flex flex-col justify-between">
                                    <div>
                                        <h3 className="font-bold text-slate-800 text-base leading-tight mb-1">{ad.title}</h3>
                                        <p className="text-slate-500 text-xs line-clamp-2 leading-relaxed">{ad.description}</p>
                                    </div>
                                    <div className="flex items-center justify-between pt-1">
                                        <span className="text-[10px] text-slate-400">{ad.subLabel || ''}</span>
                                        <a href={ad.linkUrl} target="_blank" className="text-xs font-bold text-black hover:text-slate-700 flex items-center gap-1 hover:underline">{ad.ctaText}<Icons.ExternalLink className="w-3 h-3" /></a>
                                    </div>
                                </div>
                        </div>
                      ))}
                  </div>
                </div>
            );
        };

        const OfferCard = ({ offer, onContact, onUserClick, onRate, onDelete, currentUserId, viewMode = 'grid' }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isOngoing = offer.durationType === 'ongoing';
            const isPending = offer.status === 'pending';
            const isOwner = currentUserId === offer.profileId;
            const ratingCount = offer.ratings?.length || 0;
            const ratingScore = offer.averageRating || 0;
            const isHighRated = ratingScore >= 4;

            const renderStars = (compact) => (
                <div className="flex items-center gap-1">
                    {[1,2,3,4,5].map(s => (
                        <Icons.Star key={s} className={`${compact ? 'w-2.5 h-2.5' : 'w-3.5 h-3.5'} ${Math.round(ratingScore) >= s ? 'text-amber-400 fill-amber-400' : 'text-slate-200'}`} />
                    ))}
                    <span className="text-[10px] text-slate-400">{isHighRated ? 'מומלץ בחום' : (ratingCount ? `(${ratingCount})` : 'טרם דורג')}</span>
                </div>
            );

            if (viewMode === 'compact') {
                return (
                    <div className={`bg-white rounded-xl shadow-sm border overflow-hidden hover:shadow-md transition-all ${isPending ? 'border-orange-300 bg-orange-50/20' : 'border-slate-200'}`}>
                        <div className="p-3 cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                            <div className="flex items-start gap-3">
                                <div className="relative shrink-0" onClick={(e) => { e.stopPropagation(); onUserClick(offer.profile); }}>
                                    <img src={offer.profile?.avatarUrl} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm" />
                                    <span className={`absolute -bottom-1 -right-1 px-1.5 py-1 rounded-full text-[10px] font-bold text-white flex items-center justify-center ${isOngoing ? 'bg-blue-600' : 'bg-orange-500'}`}>
                                        {isOngoing ? <Icons.Repeat className="w-3 h-3" /> : <Icons.Clock className="w-3 h-3" />}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-bold text-slate-900 text-lg flex items-center gap-2">
                                                {offer.title}
                                                {isPending && <span className="text-xs bg-orange-100 text-orange-700 px-2 rounded-full">ממתין</span>}
                                            </h3>
                                            <div className="my-1">{renderStars(true)}</div>
                                        </div>
                                        <div className="text-slate-300">{isExpanded ? <Icons.ChevronUp className="w-5 h-5" /> : <Icons.ChevronDown className="w-5 h-5" />}</div>
                                    </div>
                                    <div className="flex flex-col gap-1 mt-1 w-full">
                                        <div className="flex items-start gap-1"><span className="text-xs font-bold text-indigo-600 shrink-0 w-12">מבקש/ת:</span><span className="text-xs text-slate-700 truncate">{offer.requestedService}</span></div>
                                        <div className="flex items-start gap-1"><span className="text-xs font-bold text-emerald-600 shrink-0 w-12">נותן/ת:</span><span className="text-xs text-slate-700 truncate">{offer.offeredService}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {isExpanded && (
                            <div className="px-3 pb-3 pt-0 border-t border-slate-100 mt-2 pt-2">
                                <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg mb-3">{offer.description}</p>
                                <div className="flex justify-between items-center">
                                    <div className="text-xs text-slate-400 flex gap-2">
                                        <span className="flex items-center gap-1"><Icons.MapPin className="w-3 h-3"/> {offer.location}</span>
                                        {offer.expirationDate && <span className="text-red-500">עד: {offer.expirationDate}</span>}
                                    </div>
                                    {isOwner && onDelete ? (
                                        <button onClick={(e) => { e.stopPropagation(); if(confirm('למחוק?')) onDelete(offer.id); }} className="text-red-500 text-xs">מחק</button>
                                    ) : (
                                        <button onClick={(e) => { e.stopPropagation(); onContact(offer.profile); }} className="bg-slate-900 text-white text-xs px-4 py-2 rounded-lg">שלח הודעה</button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all flex flex-col h-full relative ${isPending ? 'border-orange-300 bg-orange-50/10' : ''}`}>
                    <div className="absolute top-4 left-4 z-10 flex flex-col items-end gap-1.5">
                        <div className={`px-2 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 shadow-sm ${isOngoing ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-orange-50 text-orange-700 border-orange-100'}`}>
                            {isOngoing ? <Icons.Repeat className="w-3 h-3" /> : <Icons.Clock className="w-3 h-3" />}
                            {isOngoing ? 'מתמשך' : 'חד פעמי'}
                        </div>
                        {isPending && <div className="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-[10px] font-bold">ממתין לאישור</div>}
                        {offer.expirationDate && <div className="bg-red-50 text-red-600 border border-red-100 px-2 py-1 rounded-full text-[10px] font-bold">עד: {offer.expirationDate}</div>}
                    </div>

                    <div className="p-5 flex-1 flex flex-col">
                        <div className="flex items-center gap-3 mb-3 cursor-pointer" onClick={() => onUserClick(offer.profile)}>
                            <img src={offer.profile?.avatarUrl} className="w-10 h-10 rounded-full object-cover border border-slate-100" />
                            <div>
                                <h4 className="text-sm font-bold text-slate-900">{offer.profile?.name}</h4>
                                <span className="text-xs text-brand-600 bg-brand-50 px-2 py-0.5 rounded-full">{offer.profile?.expertise || 'מומחה'}</span>
                            </div>
                        </div>
                        <div className="mb-2">{renderStars()}</div>
                        <h3 className="text-lg font-bold mb-3 leading-tight min-h-[3.5rem]">{offer.title}</h3>
                        <div className="space-y-2 mb-3">
                            <div className="p-2 rounded-lg bg-emerald-50 border border-emerald-100"><span className="block text-xs font-bold text-emerald-600">נותן:</span><p className="text-sm text-slate-700">{offer.offeredService}</p></div>
                            <div className="p-2 rounded-lg bg-indigo-50 border border-indigo-100"><span className="block text-xs font-bold text-indigo-600">מבקש:</span><p className="text-sm text-slate-700">{offer.requestedService}</p></div>
                        </div>
                        <div className="h-20 overflow-y-auto mb-2 custom-scrollbar"><p className="text-sm text-slate-500 leading-relaxed">{offer.description}</p></div>
                    </div>

                    <div className="bg-slate-50 px-5 py-3 border-t border-slate-100 flex items-center justify-between gap-4">
                        <div className="flex flex-col gap-1 text-xs text-slate-400">
                            <div className="flex items-center gap-1"><Icons.MapPin className="w-3 h-3" />{offer.location}</div>
                            <div className="flex items-center gap-1"><Icons.Calendar className="w-3 h-3" />{new Date(offer.createdAt).toLocaleDateString('he-IL')}</div>
                        </div>
                        {isOwner && onDelete ? (
                            <button onClick={() => { if(confirm('למחוק?')) onDelete(offer.id); }} className="text-slate-400 hover:text-red-500"><Icons.Trash2 className="w-4 h-4" /></button>
                        ) : (
                            <button onClick={() => onContact(offer.profile)} className="bg-slate-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-slate-800 flex items-center gap-2"><Icons.MessageCircle className="w-4 h-4" />שלח הודעה</button>
                        )}
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, onLogin, onRegister }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [avatarDataUrl, setAvatarDataUrl] = useState('');
            const fileRef = useRef(null);

            const handleFile = async (e) => {
                if(e.target.files?.[0]) {
                    const res = await compressImage(e.target.files[0]);
                    setAvatarDataUrl(res);
                }
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                if(isLogin) onLogin(data.email, data.password);
                else onRegister({ ...data, avatarUrl: avatarDataUrl }, data.password);
            };

            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title={isLogin ? 'התחברות' : 'הרשמה'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {!isLogin && (
                            <>
                                <div className="flex justify-center">
                                    <div className="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center cursor-pointer overflow-hidden border-2 border-slate-300" onClick={() => fileRef.current?.click()}>
                                        {avatarDataUrl ? <img src={avatarDataUrl} className="w-full h-full object-cover"/> : <Icons.Camera className="w-8 h-8 text-slate-400"/>}
                                    </div>
                                    <input type="file" ref={fileRef} className="hidden" onChange={handleFile}/>
                                </div>
                                <div><label className="block text-xs font-bold mb-1">שם מלא</label><input name="name" required className="w-full border rounded-lg p-2.5" /></div>
                            </>
                        )}
                        <div><label className="block text-xs font-bold mb-1">אימייל</label><input name="email" type="email" required className="w-full border rounded-lg p-2.5" /></div>
                        <div><label className="block text-xs font-bold mb-1">סיסמה</label><input name="password" type="password" required className="w-full border rounded-lg p-2.5" /></div>
                        {!isLogin && (
                            <div>
                                <label className="block text-xs font-bold mb-1">תחום עיסוק</label>
                                <input list="cats" name="mainField" className="w-full border rounded-lg p-2.5" placeholder="בחר או הקלד..."/>
                                <datalist id="cats">{CATEGORIES.map(c=><option key={c} value={c}/>)}</datalist>
                            </div>
                        )}
                        <button type="submit" className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700">{isLogin ? 'התחבר' : 'הירשם'}</button>
                    </form>
                    <div className="mt-4 text-center text-sm">
                        <button onClick={() => setIsLogin(!isLogin)} className="text-brand-600 font-bold hover:underline">{isLogin ? 'אין חשבון? הירשם' : 'יש חשבון? התחבר'}</button>
                    </div>
                </ModalWrapper>
            );
        };

        const CreateOfferModal = ({ isOpen, onClose, onAddOffer, currentUser }) => {
            const [step, setStep] = useState(1);
            const [rough, setRough] = useState('');
            const [loading, setLoading] = useState(false);
            const [form, setForm] = useState({});

            const handleAI = async () => {
                setLoading(true);
                const res = await optimizeOfferDescription(rough);
                setLoading(false);
                if(res) {
                    setForm({ ...res, durationType: 'one-time' });
                    setStep(2);
                } else {
                    alert("AI failed, please fill manually");
                    setStep(2);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                onAddOffer({
                    ...data,
                    id: Date.now().toString(),
                    profileId: currentUser.id,
                    profile: currentUser,
                    tags: data.tags ? data.tags.split(',') : [],
                    status: 'pending', 
                    createdAt: new Date().toISOString(),
                    ratings: [],
                    averageRating: 0
                });
                onClose();
            };

            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title="יצירת הצעה">
                    {step === 1 ? (
                        <div className="space-y-4">
                            <p className="text-sm text-slate-600">ספר לנו מה אתה מציע ומה אתה מחפש, וה-AI ינסח עבורך.</p>
                            <textarea className="w-full border rounded-xl p-3 h-32" placeholder="למשל: אני בונה אתרים ומחפש ייעוץ משפטי עד סוף החודש..." value={rough} onChange={e => setRough(e.target.value)}></textarea>
                            <button onClick={handleAI} disabled={!rough || loading} className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl flex justify-center gap-2">
                                {loading ? <Icons.Loader2 className="animate-spin" /> : <Icons.Sparkles />} נסח אוטומטית
                            </button>
                            <button onClick={() => setStep(2)} className="w-full text-slate-500 text-sm">דלג ומלא ידנית</button>
                        </div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <input name="title" defaultValue={form.title} placeholder="כותרת" className="w-full border rounded-lg p-2" required />
                            <div className="grid grid-cols-2 gap-2">
                                <input name="offeredService" defaultValue={form.offeredService} placeholder="נותן" className="w-full border rounded-lg p-2" required />
                                <input name="requestedService" defaultValue={form.requestedService} placeholder="מבקש" className="w-full border rounded-lg p-2" required />
                            </div>
                            <textarea name="description" defaultValue={form.description} placeholder="תיאור" className="w-full border rounded-lg p-2 h-24" required></textarea>
                            <div className="grid grid-cols-2 gap-2">
                                <input name="location" defaultValue={form.location} placeholder="מיקום" className="w-full border rounded-lg p-2" />
                                <select name="durationType" className="w-full border rounded-lg p-2">
                                    <option value="one-time">חד פעמי</option>
                                    <option value="ongoing">מתמשך</option>
                                </select>
                            </div>
                            <label className="block text-xs font-bold mt-2">תאריך יעד (אופציונלי)</label>
                            <input name="expirationDate" type="date" defaultValue={form.expirationDate} className="w-full border rounded-lg p-2" />
                            <input name="tags" type="hidden" value={form.tags} />
                            <button type="submit" className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl">שלח לאישור</button>
                        </form>
                    )}
                </ModalWrapper>
            );
        };

        const AdminAdManager = ({ isOpen, onClose, ads, onAddAd, onDeleteAd }) => {
            const [form, setForm] = useState({ title: '', linkUrl: '', imageUrl: '', targetCategories: '', description: '' });
            if(!isOpen) return null;

            const handleDuplicate = (ad) => {
                setForm({
                    ...ad,
                    title: ad.title + ' (עותק)',
                    targetCategories: ad.targetCategories.join(','),
                    imageUrl: ad.imageUrl
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onAddAd({
                    ...form,
                    id: Date.now().toString(),
                    targetCategories: form.targetCategories.split(','),
                    targetInterests: [],
                    isActive: true
                });
                setForm({ title: '', linkUrl: '', imageUrl: '', targetCategories: '', description: '' });
            };

            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title="ניהול פרסומות">
                    <div className="flex gap-4 h-[500px]">
                        <div className="w-1/2 overflow-y-auto">
                            {ads.map(ad => (
                                <div key={ad.id} className="border p-2 mb-2 rounded relative group">
                                    <img src={ad.imageUrl} className="h-20 w-full object-cover rounded" />
                                    <h4 className="font-bold">{ad.title}</h4>
                                    <button onClick={() => handleDuplicate(ad)} className="absolute top-2 left-8 bg-blue-100 p-1 rounded hover:bg-blue-200"><Icons.Copy className="w-4 h-4"/></button>
                                    <button onClick={() => onDeleteAd(ad.id)} className="absolute top-2 left-2 bg-red-100 p-1 rounded hover:bg-red-200"><Icons.Trash2 className="w-4 h-4"/></button>
                                </div>
                            ))}
                        </div>
                        <form className="w-1/2 space-y-2" onSubmit={handleSubmit}>
                            <h4 className="font-bold text-purple-600">יצירה / עריכה</h4>
                            <input className="w-full border p-2 rounded" placeholder="כותרת" value={form.title} onChange={e=>setForm({...form, title: e.target.value})} required/>
                            <input className="w-full border p-2 rounded" placeholder="תיאור" value={form.description} onChange={e=>setForm({...form, description: e.target.value})} />
                            <input className="w-full border p-2 rounded" placeholder="לינק" value={form.linkUrl} onChange={e=>setForm({...form, linkUrl: e.target.value})} required/>
                            <input className="w-full border p-2 rounded" placeholder="כתובת תמונה" value={form.imageUrl} onChange={e=>setForm({...form, imageUrl: e.target.value})} required/>
                            <input className="w-full border p-2 rounded" placeholder="תגיות (פסיקים)" value={form.targetCategories} onChange={e=>setForm({...form, targetCategories: e.target.value})} />
                            <button className="w-full bg-purple-600 text-white p-2 rounded font-bold">שמור מודעה</button>
                        </form>
                    </div>
                </ModalWrapper>
            );
        };

        // ==========================================
        // 7. MAIN APP COMPONENT
        // ==========================================

        const App = () => {
            const [user, setUser] = useState(null);
            const [offers, setOffers] = useState([]);
            const [ads, setAds] = useState([]);
            const [viewMode, setViewMode] = useState('grid');
            const [sortBy, setSortBy] = useState('newest');
            const [modals, setModals] = useState({ auth: false, create: false, adminAds: false });
            const [searchQuery, setSearchQuery] = useState('');
            
            // Firebase Listeners
            useEffect(() => {
                // Auth
                const unsubAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        const docRef = db.collection('users').doc(u.uid);
                        docRef.onSnapshot(docSnap => {
                            if (docSnap.exists) setUser({ id: u.uid, ...docSnap.data() });
                        });
                    } else {
                        setUser(null);
                    }
                });

                // Offers
                const q = db.collection('offers').orderBy('createdAt', 'desc');
                const unsubOffers = q.onSnapshot((snap) => {
                    const fetched = [];
                    snap.forEach(d => fetched.push({ id: d.id, ...d.data() }));
                    setOffers(fetched);
                });

                // Ads
                const unsubAds = db.collection('systemAds').onSnapshot(snap => {
                    const fetched = [];
                    snap.forEach(d => fetched.push({ id: d.id, ...d.data() }));
                    setAds(fetched);
                });

                return () => { unsubAuth(); unsubOffers(); unsubAds(); };
            }, []);

            const handleRegister = async (data, pass) => {
                try {
                    const cred = await auth.createUserWithEmailAndPassword(data.email, pass);
                    const profile = {
                        name: data.name,
                        email: data.email,
                        mainField: data.mainField || 'כללי',
                        role: data.email === ADMIN_EMAIL ? 'admin' : 'user',
                        avatarUrl: data.avatarUrl || `https://ui-avatars.com/api/?name=${data.name}&background=random`,
                        joinedAt: new Date().toISOString()
                    };
                    await db.collection('users').doc(cred.user.uid).set(profile);
                    setModals({ ...modals, auth: false });
                } catch(e) { alert(e.message); }
            };

            const handleLogin = async (email, pass) => {
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    setModals({ ...modals, auth: false });
                } catch(e) { alert("Login failed. Check console."); console.error(e); }
            };

            // Client-side Filtering
            const filteredOffers = offers.filter(o => {
                const isActive = o.status === 'active';
                const isMine = user && o.profileId === user.id;
                const isAdmin = user?.email === ADMIN_EMAIL;
                if (!isActive && !isMine && !isAdmin) return false;

                if(!searchQuery) return true;
                return o.title.includes(searchQuery) || o.description.includes(searchQuery);
            }).sort((a,b) => {
                if (sortBy === 'deadline' && a.expirationDate && b.expirationDate) return new Date(a.expirationDate) - new Date(b.expirationDate);
                if (sortBy === 'rating') return (b.averageRating || 0) - (a.averageRating || 0);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            return (
                <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
                    <Navbar 
                        currentUser={user} 
                        onOpenAuth={() => setModals({...modals, auth: true})}
                        onOpenCreateModal={() => user ? setModals({...modals, create: true}) : setModals({...modals, auth: true})}
                        onLogout={() => auth.signOut()}
                        onSearch={setSearchQuery}
                        onOpenAdmin={() => setModals({...modals, adminAds: true})}
                    />
                    <Hero onOpenAuth={() => setModals({...modals, auth: true})} />
                    
                    <main id="feed" className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-grow">
                        
                        <AdBanner ads={ads} currentUser={user} />

                        {/* Filters Bar */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6 sticky top-20 z-30">
                            <div className="flex justify-between items-center">
                                <h2 className="font-bold text-slate-800">סינון הצעות</h2>
                                <div className="flex gap-2">
                                    <select className="bg-slate-50 border rounded-lg text-sm p-2" onChange={e => setSortBy(e.target.value)}>
                                        <option value="newest">חדש ביותר</option>
                                        <option value="deadline">מסתיימות בקרוב</option>
                                        <option value="rating">הכי מומלצות</option>
                                    </select>
                                    <div className="flex bg-slate-50 rounded-lg p-1 border">
                                        <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded ${viewMode === 'grid' ? 'bg-white shadow' : ''}`}><Icons.LayoutGrid className="w-4 h-4" /></button>
                                        <button onClick={() => setViewMode('compact')} className={`p-1.5 rounded ${viewMode === 'compact' ? 'bg-white shadow' : ''}`}><Icons.ListIcon className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Grid */}
                        <div className={`grid gap-6 ${viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1 max-w-3xl mx-auto'}`}>
                            {filteredOffers.map(offer => (
                                <OfferCard 
                                    key={offer.id} 
                                    offer={offer} 
                                    viewMode={viewMode}
                                    currentUserId={user?.id}
                                    onContact={() => user ? alert("צ'אט בקרוב...") : setModals({...modals, auth: true})}
                                    onUserClick={() => {}}
                                    onDelete={(id) => db.collection('offers').doc(id).delete()}
                                />
                            ))}
                            {/* CTA Card */}
                            <div onClick={() => user ? setModals({...modals, create: true}) : setModals({...modals, auth: true})} 
                                 className="cursor-pointer border-2 border-dashed border-brand-300 rounded-xl p-6 flex flex-col items-center justify-center text-center hover:bg-brand-50 transition-all min-h-[300px]">
                                <div className="bg-brand-100 p-4 rounded-full mb-4"><Icons.Plus className="w-8 h-8 text-brand-600" /></div>
                                <h3 className="text-xl font-bold text-slate-800">יש לך כישרון להציע?</h3>
                                <span className="mt-4 text-brand-600 font-bold bg-white px-4 py-2 rounded-full shadow-sm text-sm">פרסם הצעה חדשה &rarr;</span>
                            </div>
                        </div>
                    </main>

                    {/* Modals */}
                    <AuthModal 
                        isOpen={modals.auth} 
                        onClose={() => setModals({...modals, auth: false})} 
                        onLogin={handleLogin} 
                        onRegister={handleRegister} 
                    />
                    <CreateOfferModal 
                        isOpen={modals.create} 
                        onClose={() => setModals({...modals, create: false})} 
                        onAddOffer={async (o) => { await db.collection('offers').doc(o.id).set(o); }} 
                        currentUser={user} 
                    />
                    <AdminAdManager 
                        isOpen={modals.adminAds}
                        onClose={() => setModals({...modals, adminAds: false})}
                        ads={ads}
                        onAddAd={(ad) => db.collection('systemAds').doc(ad.id).set(ad)}
                        onDeleteAd={(id) => db.collection('systemAds').doc(id).delete()}
                    />
                    
                    <footer className="bg-teal-900 text-teal-100 border-t border-teal-800 font-sans py-12">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <p>© 2024 Barter.org.il - פלטפורמת הברטר החכמה</p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>