<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barter.org.il | זירת הברטר של העצמאים</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' }
                    },
                    fontFamily: { sans: ['Assistant', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. React & ReactDOM (UMD for Browser) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel (To compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Lucide Icons (React UMD) -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <!-- 6. Firebase SDKs (Compat Version - Works in browser without imports) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 flex flex-col min-h-screen">
    
    <div id="root"></div>

    <!-- MAIN APP LOGIC -->
    <script type="text/babel">
        
        // ==========================================
        // 1. CONFIGURATION (PASTE KEYS HERE)
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8b2B9twtEvjNW9W6yF8MriqAICyd0F64",
            authDomain: "barter-app-final.firebaseapp.com",
            projectId: "barter-app-final",
            storageBucket: "barter-app-final.firebasestorage.app",
            messagingSenderId: "376228645270",
            appId: "1:376228645270:web:d048f54c13a280051db5b7"
        };

        const GEMINI_API_KEY = "AIzaSyDQpdTeRrPk-6iYgz8zOlgdW7UitohoWzA";

        // ==========================================
        // 2. SETUP & GLOBALS
        // ==========================================

        // Initialize Firebase (Compat Mode)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // React Hooks Destructuring
        const { useState, useEffect, useRef, useMemo } = React;

        // Lucide Icons Destructuring (From UMD Global)
        const { 
            ArrowRightLeft, Menu, X, PlusCircle, MessageSquare, LogOut, Shield, FileText, 
            Search, Megaphone, BarChart3, Wallet, Users, TrendingUp, ExternalLink, 
            ChevronLeft, ChevronRight, MapPin, Calendar, ChevronDown, ChevronUp, Star, 
            Trash2, Clock, Repeat, EyeOff, Sparkles, Loader2, Tag, CheckCircle2, Heart, 
            Plus, Camera, Image: ImageIcon, Upload, CheckCircle, Save, Briefcase, 
            AlertCircle, XCircle, RefreshCw, Mail, Check, ShieldAlert, Edit, 
            Handshake, Bell, Lock, Facebook, Instagram, Linkedin, Send, AlertTriangle, 
            Accessibility, Cookie, UserCheck, Target, Ban, ArrowUpDown, LayoutGrid, List: ListIcon
        } = lucideReact;

        // ==========================================
        // 3. SERVICES (AI & UTILS)
        // ==========================================

        const optimizeOfferDescription = async (rawInput) => {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("PASTE")) {
                console.warn("Gemini Key Missing");
                return null;
            }
            try {
                const today = new Date().toISOString().split('T')[0];
                const prompt = `
                  Current Date: ${today}
                  Analyze this barter offer request: "${rawInput}"
                  Return a JSON object with:
                  - title (Hebrew, professional)
                  - description (Hebrew, persuasive)
                  - offeredService (Short Hebrew)
                  - requestedService (Short Hebrew)
                  - location (Hebrew, City or 'Remote')
                  - tags (Array of strings)
                  - expirationDate (YYYY-MM-DD, only if a deadline is explicitly mentioned relative to today)
                `;

                // Direct REST Call to avoid SDK issues in browser
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : null;
            } catch (error) {
                console.error("AI Error:", error);
                return null;
            }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                };
                reader.onerror = error => reject(error);
            });
        };

        // Constants
        const CATEGORIES = ["פיתוח אתרים", "עיצוב גרפי", "שיווק דיגיטלי", "ייעוץ עסקי", "צילום ועריכה", "משפטים", "חשבונאות"];
        const COMMON_INTERESTS = ["ספורט", "מוזיקה", "טיולים", "קולנוע", "בישול", "טכנולוגיה", "אופנה", "עיצוב", "גיימינג", "נדל״ן"];
        const DEFAULT_SYSTEM_ADS = [
            { id: 'ad1', targetCategories: ['Global'], targetInterests: ['מוזיקה'], title: 'כלי נגינה במחירים מדהימים', description: 'גיטרות, פסנתרים ותופים. משלוח חינם.', ctaText: 'לקטלוג', linkUrl: '#', imageUrl: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80', isActive: true },
            { id: 'ad2', targetCategories: ['פיתוח אתרים'], targetInterests: ['טכנולוגיה'], title: 'אלמנטור פרו - המנוי המשתלם', description: 'בונה האתרים הטוב בעולם במבצע.', ctaText: 'רכוש עכשיו', linkUrl: '#', imageUrl: 'https://images.unsplash.com/photo-1507238691740-187a5b1d37b8?w=800&q=80', isActive: true }
        ];

        // ==========================================
        // 4. COMPONENTS
        // ==========================================

        const ModalWrapper = ({ isOpen, onClose, children, title }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 overflow-y-auto">
                    <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
                        <div className="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" onClick={onClose}></div>
                        <div className="inline-block bg-white rounded-2xl text-right overflow-hidden shadow-xl transform transition-all sm:max-w-lg w-full">
                            <div className="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50">
                                <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                                <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
                            </div>
                            <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const Navbar = ({ currentUser, onOpenCreateModal, onOpenAuth, onLogout, onSearch, unreadCount }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            return (
                <nav className="bg-white border-b border-slate-200 sticky top-0 z-40">
                  <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between h-16">
                      <div className="flex items-center flex-1">
                        <div className="flex-shrink-0 flex items-center gap-2 cursor-pointer" onClick={() => window.scrollTo(0,0)}>
                          <div className="bg-brand-600 p-1.5 rounded-lg"><ArrowRightLeft className="h-6 w-6 text-white" /></div>
                          <span className="font-bold text-xl text-slate-800 hidden md:block">Barter.org.il</span>
                        </div>
                        <div className="hidden md:flex items-center mr-8 flex-1 max-w-lg">
                           <div className="relative w-full">
                              <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><Search className="h-4 w-4 text-slate-400" /></div>
                              <input type="text" className="block w-full pl-4 pr-10 py-1.5 border border-slate-300 rounded-full bg-slate-50 text-slate-900 text-sm focus:outline-none focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500" placeholder="חיפוש שירות..." onChange={(e) => onSearch(e.target.value)} />
                           </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-2 sm:gap-4">
                        {currentUser ? (
                          <div className="flex items-center gap-3 pl-2 border-r border-slate-200 mr-2">
                               <img src={currentUser.avatarUrl} className="w-8 h-8 rounded-full border border-slate-200 object-cover" />
                               <span className="text-sm font-medium text-slate-700 hidden lg:block">{currentUser.name}</span>
                               <button onClick={onLogout} className="text-slate-400 hover:text-red-500 p-1"><LogOut className="w-5 h-5" /></button>
                          </div>
                        ) : (
                          <button onClick={onOpenAuth} className="text-sm font-medium text-slate-600 hover:text-brand-600">התחברות / הרשמה</button>
                        )}
                        <button onClick={onOpenCreateModal} className="bg-brand-600 hover:bg-brand-700 text-white px-3 sm:px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 shadow-sm transition-colors"><PlusCircle className="w-4 h-4" /><span className="inline">פרסם הצעה</span></button>
                      </div>
                    </div>
                  </div>
                </nav>
            );
        };

        const Hero = () => {
            return (
                <div className="relative bg-white overflow-hidden flex flex-col lg:flex-row border-b border-slate-100 min-h-[600px]">
                  <div className="w-full lg:w-[55%] bg-white z-20 flex flex-col justify-center relative order-1 lg:order-1">
                      <main className="w-full max-w-2xl px-4 py-10 sm:px-6 lg:px-8 lg:py-24 flex flex-col items-end text-right mr-auto"> 
                        <div className="w-full pl-0 lg:pl-10">
                          <h1 className="text-4xl tracking-tight font-extrabold text-slate-900 sm:text-5xl md:text-6xl leading-tight">
                            <span className="block">הכלכלה החדשה של</span>
                            <span className="block text-brand-600 mt-1">העצמאים בישראל</span>
                          </h1>
                          <p className="mt-6 text-base text-slate-500 sm:mt-8 sm:text-lg sm:max-w-xl md:mt-8 md:text-xl leading-relaxed">
                            השתמשו בכישורים שלכם כדי לשלם על שירותים עסקיים. בלי להוציא מזומן, בלי עמלות נסתרות. נטוורקינג עסקי אמיתי שמייצר ערך מהיום הראשון.
                          </p>
                          <div className="mt-8 sm:mt-10 flex flex-col sm:flex-row gap-1.5 sm:gap-4 justify-start">
                            <button className="w-full flex items-center justify-center px-8 py-4 border border-transparent text-base font-bold rounded-lg text-white bg-brand-600 hover:bg-brand-700 md:text-lg transition-all">מצאו שותף לברטר</button>
                          </div>
                        </div>
                      </main>
                  </div>
                  <div className="w-full lg:w-[45%] bg-slate-50 relative min-h-[500px] lg:min-h-full flex items-center justify-center overflow-hidden order-2 lg:border-r border-slate-100 p-8">
                    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:20px_20px]"></div>
                    <div className="relative w-full max-w-sm flex flex-col gap-5">
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center flex-shrink-0"><Wallet className="w-6 h-6 text-emerald-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">חוסכים בהוצאות העסק</h3><p className="text-slate-500 text-sm leading-relaxed">משתמשים בכישרון שלכם כמטבע עבור הסוחר.<br/>מקבלים שירותים שווים בלי להוציא שקל.</p></div>
                        </div>
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center flex-shrink-0"><Users className="w-6 h-6 text-indigo-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">קהילה עסקית איכותית</h3><p className="text-slate-500 text-sm leading-relaxed">נבחרת של פרילנסרים ובעלי עסקים מנוסים. כאן תמצאו שותפים רציניים לעבודה.</p></div>
                        </div>
                        <div className="w-full bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex items-start gap-4">
                            <div className="w-12 h-12 bg-rose-50 rounded-xl flex items-center justify-center flex-shrink-0"><TrendingUp className="w-6 h-6 text-rose-600" /></div>
                            <div><h3 className="font-bold text-slate-900 text-lg mb-1">הזדמנויות צמיחה</h3><p className="text-slate-500 text-sm leading-relaxed">הדרך הנכונה להגדיל את היקף העבודות, לייצר קשרים אסטרטגיים ולפרוץ לשווקים חדשים.</p></div>
                        </div>
                    </div>
                  </div>
                </div>
            );
        };

        const OfferCard = ({ offer, onContact, onUserClick, onRate, onDelete, currentUserId, viewMode = 'grid' }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isOngoing = offer.durationType === 'ongoing';
            const isPending = offer.status === 'pending';
            const isOwner = currentUserId === offer.profileId;
            const ratingCount = offer.ratings?.length || 0;
            const ratingScore = offer.averageRating || 0;
            const isHighRated = ratingScore >= 4;

            const renderStars = (compact) => (
                <div className="flex items-center gap-1">
                    {[1,2,3,4,5].map(s => (
                        <Star key={s} className={`${compact ? 'w-2.5 h-2.5' : 'w-3.5 h-3.5'} ${Math.round(ratingScore) >= s ? 'text-amber-400 fill-amber-400' : 'text-slate-200'}`} />
                    ))}
                    <span className="text-[10px] text-slate-400">{isHighRated ? 'מומלץ בחום' : (ratingCount ? `(${ratingCount})` : 'טרם דורג')}</span>
                </div>
            );

            if (viewMode === 'compact') {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all">
                        <div className="p-3 cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                            <div className="flex items-start gap-3">
                                <div className="relative shrink-0">
                                    <img src={offer.profile?.avatarUrl} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm" />
                                    <span className={`absolute -bottom-1 -right-1 px-1.5 py-1 rounded-full text-[10px] font-bold text-white flex items-center justify-center ${isOngoing ? 'bg-blue-600' : 'bg-orange-500'}`}>
                                        {isOngoing ? <Repeat className="w-3 h-3" /> : <Clock className="w-3 h-3" />}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-bold text-slate-900 text-lg flex items-center gap-2">
                                                {offer.title}
                                                {isPending && <span className="text-xs bg-orange-100 text-orange-700 px-2 rounded-full">ממתין</span>}
                                            </h3>
                                            <div className="my-1">{renderStars(true)}</div>
                                        </div>
                                        <div className="text-slate-300">{isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}</div>
                                    </div>
                                    <div className="flex flex-col gap-1 mt-1 w-full">
                                        <div className="flex items-start gap-1"><span className="text-xs font-bold text-indigo-600 shrink-0 w-12">מבקש/ת:</span><span className="text-xs text-slate-700 truncate">{offer.requestedService}</span></div>
                                        <div className="flex items-start gap-1"><span className="text-xs font-bold text-emerald-600 shrink-0 w-12">נותן/ת:</span><span className="text-xs text-slate-700 truncate">{offer.offeredService}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {isExpanded && (
                            <div className="px-3 pb-3 pt-0 border-t border-slate-100 mt-2 pt-2">
                                <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg mb-3">{offer.description}</p>
                                <div className="flex justify-between items-center">
                                    <div className="text-xs text-slate-400 flex gap-2">
                                        <span className="flex items-center gap-1"><MapPin className="w-3 h-3"/> {offer.location}</span>
                                        {offer.expirationDate && <span className="text-red-500">עד: {offer.expirationDate}</span>}
                                    </div>
                                    {isOwner && onDelete ? (
                                        <button onClick={(e) => { e.stopPropagation(); if(confirm('למחוק?')) onDelete(offer.id); }} className="text-red-500 text-xs">מחק</button>
                                    ) : (
                                        <button onClick={(e) => { e.stopPropagation(); onContact(offer.profile); }} className="bg-slate-900 text-white text-xs px-4 py-2 rounded-lg">שלח הודעה</button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all flex flex-col h-full relative ${isPending ? 'border-orange-300' : ''}`}>
                    <div className="absolute top-4 left-4 z-10 flex flex-col items-end gap-1.5">
                        <div className={`px-2 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 shadow-sm ${isOngoing ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-orange-50 text-orange-700 border-orange-100'}`}>
                            {isOngoing ? <Repeat className="w-3 h-3" /> : <Clock className="w-3 h-3" />}
                            {isOngoing ? 'מתמשך' : 'חד פעמי'}
                        </div>
                        {isPending && <div className="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-[10px] font-bold">ממתין לאישור</div>}
                        {offer.expirationDate && <div className="bg-red-50 text-red-600 border border-red-100 px-2 py-1 rounded-full text-[10px] font-bold">עד: {offer.expirationDate}</div>}
                    </div>

                    <div className="p-5 flex-1 flex flex-col">
                        <div className="flex items-center gap-3 mb-3 cursor-pointer" onClick={() => onUserClick(offer.profile)}>
                            <img src={offer.profile?.avatarUrl} className="w-10 h-10 rounded-full object-cover border border-slate-100" />
                            <div>
                                <h4 className="text-sm font-bold text-slate-900">{offer.profile?.name}</h4>
                                <span className="text-xs text-brand-600 bg-brand-50 px-2 py-0.5 rounded-full">{offer.profile?.expertise || 'מומחה'}</span>
                            </div>
                        </div>
                        <div className="mb-2">{renderStars()}</div>
                        <h3 className="text-lg font-bold mb-3 leading-tight min-h-[3.5rem]">{offer.title}</h3>
                        <div className="space-y-2 mb-3">
                            <div className="p-2 rounded-lg bg-emerald-50 border border-emerald-100"><span className="block text-xs font-bold text-emerald-600">נותן:</span><p className="text-sm text-slate-700">{offer.offeredService}</p></div>
                            <div className="p-2 rounded-lg bg-indigo-50 border border-indigo-100"><span className="block text-xs font-bold text-indigo-600">מבקש:</span><p className="text-sm text-slate-700">{offer.requestedService}</p></div>
                        </div>
                        <div className="h-20 overflow-y-auto mb-2 custom-scrollbar"><p className="text-sm text-slate-500 leading-relaxed">{offer.description}</p></div>
                    </div>

                    <div className="bg-slate-50 px-5 py-3 border-t border-slate-100 flex items-center justify-between gap-4">
                        <div className="flex flex-col gap-1 text-xs text-slate-400">
                            <div className="flex items-center gap-1"><MapPin className="w-3 h-3" />{offer.location}</div>
                            <div className="flex items-center gap-1"><Calendar className="w-3 h-3" />{new Date(offer.createdAt).toLocaleDateString('he-IL')}</div>
                        </div>
                        {isOwner && onDelete ? (
                            <button onClick={() => { if(confirm('למחוק?')) onDelete(offer.id); }} className="text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                        ) : (
                            <button onClick={() => onContact(offer.profile)} className="bg-slate-900 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-slate-800 flex items-center gap-2"><MessageCircle className="w-4 h-4" />שלח הודעה</button>
                        )}
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, onLogin, onRegister, availableCategories }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [avatarDataUrl, setAvatarDataUrl] = useState('');
            const fileRef = useRef(null);

            const handleFile = async (e) => {
                if(e.target.files?.[0]) {
                    const res = await compressImage(e.target.files[0]);
                    setAvatarDataUrl(res);
                }
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                if(isLogin) onLogin(data.email, data.password);
                else onRegister({ ...data, avatarUrl: avatarDataUrl }, data.password);
            };

            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title={isLogin ? 'התחברות' : 'הרשמה'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {!isLogin && (
                            <>
                                <div className="flex justify-center">
                                    <div className="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center cursor-pointer overflow-hidden border-2 border-slate-300" onClick={() => fileRef.current?.click()}>
                                        {avatarDataUrl ? <img src={avatarDataUrl} className="w-full h-full object-cover"/> : <Camera className="w-8 h-8 text-slate-400"/>}
                                    </div>
                                    <input type="file" ref={fileRef} className="hidden" onChange={handleFile}/>
                                </div>
                                <div><label className="block text-xs font-bold mb-1">שם מלא</label><input name="name" required className="w-full border rounded-lg p-2.5" /></div>
                            </>
                        )}
                        <div><label className="block text-xs font-bold mb-1">אימייל</label><input name="email" type="email" required className="w-full border rounded-lg p-2.5" /></div>
                        <div><label className="block text-xs font-bold mb-1">סיסמה</label><input name="password" type="password" required className="w-full border rounded-lg p-2.5" /></div>
                        {!isLogin && (
                            <div>
                                <label className="block text-xs font-bold mb-1">תחום עיסוק</label>
                                <input list="cats" name="mainField" className="w-full border rounded-lg p-2.5" placeholder="בחר או הקלד..."/>
                                <datalist id="cats">{availableCategories.map(c=><option key={c} value={c}/>)}</datalist>
                            </div>
                        )}
                        <button type="submit" className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700">{isLogin ? 'התחבר' : 'הירשם'}</button>
                    </form>
                    <div className="mt-4 text-center text-sm">
                        <button onClick={() => setIsLogin(!isLogin)} className="text-brand-600 font-bold hover:underline">{isLogin ? 'אין חשבון? הירשם' : 'יש חשבון? התחבר'}</button>
                    </div>
                </ModalWrapper>
            );
        };

        const CreateOfferModal = ({ isOpen, onClose, onAddOffer, currentUser }) => {
            const [step, setStep] = useState(1);
            const [rough, setRough] = useState('');
            const [loading, setLoading] = useState(false);
            const [form, setForm] = useState({});

            const handleAI = async () => {
                setLoading(true);
                const res = await optimizeOfferDescription(rough);
                setLoading(false);
                if(res) {
                    setForm({ ...res, durationType: 'one-time' });
                    setStep(2);
                } else {
                    alert("AI failed, please fill manually");
                    setStep(2);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                onAddOffer({
                    ...data,
                    id: Date.now().toString(),
                    profileId: currentUser.id,
                    profile: currentUser,
                    tags: data.tags ? data.tags.split(',') : [],
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    ratings: [],
                    averageRating: 0
                });
                onClose();
            };

            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title="יצירת הצעה">
                    {step === 1 ? (
                        <div className="space-y-4">
                            <p className="text-sm text-slate-600">ספר לנו מה אתה מציע ומה אתה מחפש, וה-AI ינסח עבורך.</p>
                            <textarea className="w-full border rounded-xl p-3 h-32" placeholder="למשל: אני בונה אתרים ומחפש ייעוץ משפטי..." value={rough} onChange={e => setRough(e.target.value)}></textarea>
                            <button onClick={handleAI} disabled={!rough || loading} className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl flex justify-center gap-2">
                                {loading ? <Loader2 className="animate-spin" /> : <Sparkles />} נסח אוטומטית
                            </button>
                            <button onClick={() => setStep(2)} className="w-full text-slate-500 text-sm">דלג ומלא ידנית</button>
                        </div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <input name="title" defaultValue={form.title} placeholder="כותרת" className="w-full border rounded-lg p-2" required />
                            <div className="grid grid-cols-2 gap-2">
                                <input name="offeredService" defaultValue={form.offeredService} placeholder="נותן" className="w-full border rounded-lg p-2" required />
                                <input name="requestedService" defaultValue={form.requestedService} placeholder="מבקש" className="w-full border rounded-lg p-2" required />
                            </div>
                            <textarea name="description" defaultValue={form.description} placeholder="תיאור" className="w-full border rounded-lg p-2 h-24" required></textarea>
                            <div className="grid grid-cols-2 gap-2">
                                <input name="location" defaultValue={form.location} placeholder="מיקום" className="w-full border rounded-lg p-2" />
                                <select name="durationType" className="w-full border rounded-lg p-2">
                                    <option value="one-time">חד פעמי</option>
                                    <option value="ongoing">מתמשך</option>
                                </select>
                            </div>
                            <input name="tags" type="hidden" value={form.tags} />
                            <button type="submit" className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl">פרסם</button>
                        </form>
                    )}
                </ModalWrapper>
            );
        };

        // ==========================================
        // 5. MAIN APP
        // ==========================================

        const App = () => {
            const [user, setUser] = useState(null);
            const [offers, setOffers] = useState([]);
            const [viewMode, setViewMode] = useState('grid');
            const [sortBy, setSortBy] = useState('newest');
            const [modals, setModals] = useState({ auth: false, create: false });
            const [searchQuery, setSearchQuery] = useState('');
            
            // Firebase Listeners (Compat Mode)
            useEffect(() => {
                // Auth Listener
                const unsubAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        // Fetch user profile from Firestore
                        const docRef = db.collection('users').doc(u.uid);
                        docRef.onSnapshot(doc => {
                            if (doc.exists) setUser({ id: u.uid, ...doc.data() });
                        });
                    } else {
                        setUser(null);
                    }
                });

                // Offers Listener
                const unsubOffers = db.collection('offers').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setOffers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubAuth(); unsubOffers(); };
            }, []);

            const handleRegister = async (data, pass) => {
                try {
                    const cred = await auth.createUserWithEmailAndPassword(data.email, pass);
                    const profile = {
                        name: data.name,
                        email: data.email,
                        mainField: data.mainField || 'כללי',
                        role: 'user',
                        avatarUrl: data.avatarUrl || `https://ui-avatars.com/api/?name=${data.name}&background=random`,
                        joinedAt: new Date().toISOString()
                    };
                    await db.collection('users').doc(cred.user.uid).set(profile);
                    setModals({ ...modals, auth: false });
                } catch(e) { alert(e.message); }
            };

            const handleLogin = async (email, pass) => {
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    setModals({ ...modals, auth: false });
                } catch(e) { alert("Login failed"); }
            };

            // Client-side Filtering
            const filteredOffers = offers.filter(o => {
                if(!searchQuery) return true;
                return o.title.includes(searchQuery) || o.description.includes(searchQuery);
            }).sort((a,b) => {
                if (sortBy === 'deadline' && a.expirationDate && b.expirationDate) return new Date(a.expirationDate) - new Date(b.expirationDate);
                if (sortBy === 'rating') return (b.averageRating || 0) - (a.averageRating || 0);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            return (
                <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
                    <Navbar 
                        currentUser={user} 
                        onOpenAuth={() => setModals({...modals, auth: true})}
                        onOpenCreateModal={() => user ? setModals({...modals, create: true}) : setModals({...modals, auth: true})}
                        onLogout={() => auth.signOut()}
                        onSearch={setSearchQuery}
                    />
                    <Hero />
                    
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-grow">
                        {/* Filters Bar */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6 sticky top-20 z-30">
                            <div className="flex justify-between items-center">
                                <h2 className="font-bold text-slate-800">סינון הצעות</h2>
                                <div className="flex gap-2">
                                    <select className="bg-slate-50 border rounded-lg text-sm p-2" onChange={e => setSortBy(e.target.value)}>
                                        <option value="newest">חדש ביותר</option>
                                        <option value="deadline">מסתיימות בקרוב</option>
                                        <option value="rating">הכי מומלצות</option>
                                    </select>
                                    <div className="flex bg-slate-50 rounded-lg p-1 border">
                                        <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded ${viewMode === 'grid' ? 'bg-white shadow' : ''}`}><LayoutGrid className="w-4 h-4" /></button>
                                        <button onClick={() => setViewMode('compact')} className={`p-1.5 rounded ${viewMode === 'compact' ? 'bg-white shadow' : ''}`}><ListIcon className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Grid */}
                        <div className={`grid gap-6 ${viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1 max-w-3xl mx-auto'}`}>
                            {filteredOffers.map(offer => (
                                <OfferCard 
                                    key={offer.id} 
                                    offer={offer} 
                                    viewMode={viewMode}
                                    currentUserId={user?.id}
                                    onContact={() => user ? alert("צ'אט בקרוב...") : setModals({...modals, auth: true})}
                                    onUserClick={() => {}}
                                    onDelete={(id) => db.collection('offers').doc(id).delete()}
                                />
                            ))}
                            {/* CTA Card */}
                            <div onClick={() => user ? setModals({...modals, create: true}) : setModals({...modals, auth: true})} 
                                 className="cursor-pointer border-2 border-dashed border-brand-300 rounded-xl p-6 flex flex-col items-center justify-center text-center hover:bg-brand-50 transition-all min-h-[300px]">
                                <div className="bg-brand-100 p-4 rounded-full mb-4"><Plus className="w-8 h-8 text-brand-600" /></div>
                                <h3 className="text-xl font-bold text-slate-800">יש לך כישרון להציע?</h3>
                                <span className="mt-4 text-brand-600 font-bold bg-white px-4 py-2 rounded-full shadow-sm text-sm">פרסם הצעה חדשה &rarr;</span>
                            </div>
                        </div>
                    </main>

                    {/* Modals */}
                    <AuthModal 
                        isOpen={modals.auth} 
                        onClose={() => setModals({...modals, auth: false})} 
                        onLogin={handleLogin} 
                        onRegister={handleRegister} 
                        availableCategories={CATEGORIES}
                    />
                    <CreateOfferModal 
                        isOpen={modals.create} 
                        onClose={() => setModals({...modals, create: false})} 
                        onAddOffer={async (o) => { await db.collection('offers').doc(o.id).set(o); }} 
                        currentUser={user} 
                    />
                    
                    <footer className="bg-slate-900 text-slate-400 py-8 text-center text-sm mt-auto border-t border-slate-800">
                        <p>© 2024 Barter.org.il - פלטפורמת הברטר החכמה</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>